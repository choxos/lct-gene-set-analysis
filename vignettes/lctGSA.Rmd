---
title: "Getting Started with lctGSA"
author: "Sara Khademioureh"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with lctGSA}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

## Introduction

The **lctGSA** package implements the Linear Combination Test (LCT) for identifying differentially expressed gene sets in high-dimensional gene expression data. LCT tests whether any linear combination of genes in a set is associated with a phenotype using permutation-based significance testing.

### Key Features

- **Multiple covariance estimators**: Shrinkage, Ridge, Graphical Lasso, Adaptive Lasso
- **Handles high-dimensional data**: Works when number of genes exceeds samples
- **Unbalanced designs**: Robust methods for imbalanced group sizes
- **FDR correction**: Automatic q-value calculation for multiple gene sets
- **Fast permutation testing**: Efficient implementation with reasonable defaults

## Installation

```{r install, eval = FALSE}
# From GitHub
devtools::install_github("sara-khademi/lct-gene-set-analysis")

# Load package
library(lctGSA)
```

```{r load, message = FALSE}
library(lctGSA)
```

## Quick Start: Basic Workflow

### Step 1: Prepare Your Data

LCT requires three inputs:

1. **Expression matrix**: Genes × samples (with row names as gene IDs)
2. **Phenotype vector**: Binary group labels (0/1, control/case)
3. **Gene sets**: List or data frame defining gene groupings

```{r data}
# Set seed for reproducibility
set.seed(123)

# Create example expression data (500 genes × 40 samples)
n_genes <- 500
n_samples <- 40

expression_data <- matrix(
  rnorm(n_genes * n_samples, mean = 5, sd = 2),
  nrow = n_genes,
  ncol = n_samples
)

# Add differential expression to first 50 genes
expression_data[1:50, 21:40] <- expression_data[1:50, 21:40] + 2

# Set gene and sample names
rownames(expression_data) <- paste0("Gene_", 1:n_genes)
colnames(expression_data) <- paste0("Sample_", 1:n_samples)

# Create phenotype (20 controls, 20 cases)
phenotype <- c(rep(0, 20), rep(1, 20))

# Define gene sets
gene_sets <- list(
  Pathway_A = paste0("Gene_", 1:60),    # Contains DE genes
  Pathway_B = paste0("Gene_", 40:100),  # Partially DE
  Pathway_C = paste0("Gene_", 200:250)  # No DE genes
)

# Display data structure
cat("Expression data dimensions:", dim(expression_data), "\n")
cat("Number of gene sets:", length(gene_sets), "\n")
cat("Phenotype distribution:", table(phenotype), "\n")
```

### Step 2: Run LCT Analysis

Use `perform_LCT()` to analyze all gene sets:

```{r analysis, eval = FALSE}
# Run LCT with default shrinkage method
results <- perform_LCT(
  GS = gene_sets,
  DATA = as.data.frame(expression_data),
  cl = phenotype,
  nbPermutations = 1000,
  method = "shrinkage"
)

print(results)
```

```{r analysis_output, echo = FALSE, eval = FALSE}
#   GS_name GS_size  p_value  q_value    method
# Pathway_A      60    0.001    0.003 shrinkage
# Pathway_B      61    0.045    0.068 shrinkage
# Pathway_C      51    0.523    0.523 shrinkage
```

### Step 3: Interpret Results

The output data frame contains:

- **GS_name**: Gene set identifier
- **GS_size**: Number of genes in set (after matching with expression data)
- **p_value**: Permutation-based p-value
- **q_value**: FDR-adjusted q-value (for multiple gene sets)
- **method**: Covariance estimation method used

**Interpretation**:
- Small p-values (e.g., < 0.05) suggest differential expression
- Use q-values for multiple testing correction
- Pathway_A is highly significant (contains many DE genes)

## Method Selection Guide

### When to Use Each Method

**Shrinkage (default)**:
- ✅ Best for balanced designs (equal group sizes)
- ✅ Fastest method (~0.5-1 sec per gene set)
- ✅ General-purpose, works well in most scenarios

**Ridge**:
- ✅ Recommended for unbalanced designs (e.g., 25 vs 5)
- ✅ Better Type I error control with imbalanced groups
- ✅ Similar speed to shrinkage

**Graphical Lasso**:
- ✅ Identifies sparse network structures
- ✅ Good for pathway analysis
- ⚠️ Slower (~4-8 sec per gene set)

**Adaptive Lasso**:
- ✅ Oracle properties (optimal selection + estimation)
- ✅ Automatic feature selection
- ⚠️ Moderate speed (~1-2 sec per gene set)

### Comparing Methods

```{r compare_methods, eval = FALSE}
methods <- c("shrinkage", "ridge", "glasso", "adaptive_lasso")
results_comparison <- list()

for (method in methods) {
  results_comparison[[method]] <- perform_LCT(
    GS = gene_sets,
    DATA = as.data.frame(expression_data),
    cl = phenotype,
    nbPermutations = 1000,
    method = method
  )
}

# Extract p-values for comparison
p_values <- do.call(cbind, lapply(results_comparison, function(x) x$p_value))
colnames(p_values) <- methods
rownames(p_values) <- gene_sets

print(round(p_values, 4))
```

## Working with Real Data

### Gene Set Formats

**List format** (recommended):
```{r geneset_list}
# Named list of gene IDs
my_gene_sets <- list(
  KEGG_GLYCOLYSIS = c("HK1", "HK2", "PFK1", "ALDOA"),
  REACTOME_APOPTOSIS = c("TP53", "BAX", "BCL2", "CASP3"),
  GO_IMMUNE_RESPONSE = c("TNF", "IL6", "IL1B", "IFNG")
)
```

**Data frame format**:
```{r geneset_df}
# Binary matrix: genes × gene sets
gs_matrix <- matrix(0, nrow = 500, ncol = 3)
rownames(gs_matrix) <- paste0("Gene_", 1:500)
colnames(gs_matrix) <- c("Set1", "Set2", "Set3")

gs_matrix[1:20, 1] <- 1
gs_matrix[30:60, 2] <- 1
gs_matrix[100:150, 3] <- 1

my_gene_sets_df <- as.data.frame(gs_matrix)
```

### Loading Gene Sets from GMT Files

```{r gmt, eval = FALSE}
# Function to read GMT format (MSigDB, KEGG, etc.)
read_gmt <- function(gmt_file) {
  lines <- readLines(gmt_file)
  gene_sets <- list()

  for (line in lines) {
    fields <- strsplit(line, "\t")[[1]]
    set_name <- fields[1]
    genes <- fields[-(1:2)]  # Skip name and description
    gene_sets[[set_name]] <- genes
  }

  return(gene_sets)
}

# Example usage
# msigdb_sets <- read_gmt("h.all.v7.5.1.symbols.gmt")
# results <- perform_LCT(msigdb_sets, expression_data, phenotype)
```

## Advanced Usage

### Tuning Permutations

```{r permutations, eval = FALSE}
# More permutations = more precise p-values (but slower)
# Rule of thumb: use ≥ 100/α where α is your significance level

# For α = 0.05:
results_precise <- perform_LCT(
  GS = gene_sets,
  DATA = as.data.frame(expression_data),
  cl = phenotype,
  nbPermutations = 2000  # More precise
)

# For very small p-values (α = 0.001):
results_very_precise <- perform_LCT(
  GS = gene_sets,
  DATA = as.data.frame(expression_data),
  cl = phenotype,
  nbPermutations = 100000  # Highest precision
)
```

### Single Gene Set Analysis

```{r single_set, eval = FALSE}
# Use individual LCT functions for more control
single_pathway <- expression_data[1:60, ]  # Extract genes

p_value <- LCT.shrinkage(
  DATA = single_pathway,
  cl = phenotype,
  nbPermutations = 1000
)

cat("Single pathway p-value:", p_value, "\n")
```

## Troubleshooting

### Common Issues

**Issue**: "qvalue package not available" warning
**Solution**: Install qvalue from Bioconductor:
```{r install_qvalue, eval = FALSE}
BiocManager::install("qvalue")
```

**Issue**: Gene sets have 0 size after matching
**Solution**: Check that gene IDs in gene sets match rownames of expression data

**Issue**: Slow computation with GLASSO
**Solution**: Use fewer permutations or switch to faster method

## Next Steps

- **Method Selection**: See `vignette("method-selection", package = "lctGSA")` for detailed method comparison
- **Simulation Studies**: Use `simulate_gene_expression()` and `run_LCT_simulation()` for power analysis
- **Help**: Use `?perform_LCT` or `?LCT.shrinkage` for function documentation

## References

Wang, X., Dinu, I., Liu, W., & Yasui, Y. (2011). Linear combination test for hierarchical gene set analysis. *Statistical Applications in Genetics and Molecular Biology*, 10(1). https://doi.org/10.2202/1544-6115.1618

Schäfer, J., & Strimmer, K. (2005). A shrinkage approach to large-scale covariance matrix estimation and implications for functional genomics. *Statistical Applications in Genetics and Molecular Biology*, 4(1). https://doi.org/10.2202/1544-6115.1175

## Session Information

```{r session_info}
sessionInfo()
```
